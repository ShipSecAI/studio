# OpenSearch Security - Roles Configuration (SaaS Model)
#
# INDEX ISOLATION STRATEGY:
# Each customer's data is stored in indices prefixed with their customer ID:
#   {customer_id}-analytics-*
#   {customer_id}-workflows-*
#   {customer_id}-scans-*
#
# Roles are created dynamically per customer with index patterns that
# restrict access to only their data. This file defines role templates
# and system roles.
#
# Dynamic role creation example (via backend):
#   PUT /_plugins/_security/api/roles/customer_{customer_id}
#   {
#     "cluster_permissions": ["cluster_composite_ops_ro"],
#     "index_permissions": [{
#       "index_patterns": ["{customer_id}-*"],
#       "allowed_actions": ["read", "indices:data/read/*"]
#     }],
#     "tenant_permissions": [{
#       "tenant_patterns": ["{customer_id}"],
#       "allowed_actions": ["kibana_all_write"]
#     }]
#   }

---
_meta:
  type: "roles"
  config_version: 2

# =============================================================================
# SYSTEM ROLES (Platform Operations)
# =============================================================================

# Platform admin - full access for operators
platform_admin:
  reserved: true
  cluster_permissions:
    - "*"
  index_permissions:
    - index_patterns:
        - "*"
      allowed_actions:
        - "*"
  tenant_permissions:
    - tenant_patterns:
        - "__platform_admin"
      allowed_actions:
        - "kibana_all_write"

# =============================================================================
# CUSTOMER ROLE TEMPLATE
# These are templates - actual roles are created dynamically per customer
# =============================================================================

# Template: Customer read-write access (for active users)
# Actual role name: customer_{customer_id}_rw
# Index pattern: {customer_id}-*
customer_template_rw:
  reserved: false
  description: "Template for customer read-write roles - DO NOT USE DIRECTLY"
  cluster_permissions:
    - "cluster_composite_ops_ro"
    - "indices:data/read/scroll*"
  index_permissions:
    - index_patterns:
        - "CUSTOMER_ID_PLACEHOLDER-*"
      allowed_actions:
        - "read"
        - "write"
        - "create_index"
        - "indices:data/read/*"
        - "indices:data/write/*"
        - "indices:admin/mapping/put"
  tenant_permissions:
    - tenant_patterns:
        - "CUSTOMER_ID_PLACEHOLDER"
      allowed_actions:
        - "kibana_all_write"

# Template: Customer read-only access (for viewers)
# Actual role name: customer_{customer_id}_ro
# Index pattern: {customer_id}-*
customer_template_ro:
  reserved: false
  description: "Template for customer read-only roles - DO NOT USE DIRECTLY"
  cluster_permissions:
    - "cluster_composite_ops_ro"
  index_permissions:
    - index_patterns:
        - "CUSTOMER_ID_PLACEHOLDER-*"
      allowed_actions:
        - "read"
        - "indices:data/read/*"
  tenant_permissions:
    - tenant_patterns:
        - "CUSTOMER_ID_PLACEHOLDER"
      allowed_actions:
        - "kibana_all_read"

# =============================================================================
# DASHBOARDS INTERNAL ROLES
# =============================================================================

# Dashboards server role - for backend communication
kibana_server:
  reserved: true
  cluster_permissions:
    - "cluster_monitor"
    - "cluster_composite_ops"
    - "indices:admin/template/*"
    - "indices:data/read/scroll*"
  index_permissions:
    - index_patterns:
        - ".kibana"
        - ".kibana_*"
        - ".opensearch_dashboards"
        - ".opensearch_dashboards_*"
      allowed_actions:
        - "indices_all"
    - index_patterns:
        - "*"
      allowed_actions:
        - "indices:admin/aliases/get"
        - "indices:admin/mappings/get"

# Read-only dashboard user (for embedding/sharing)
kibana_read_only:
  reserved: true
  cluster_permissions:
    - "cluster_composite_ops_ro"
  index_permissions:
    - index_patterns:
        - ".kibana"
        - ".kibana_*"
        - ".opensearch_dashboards"
        - ".opensearch_dashboards_*"
      allowed_actions:
        - "read"
